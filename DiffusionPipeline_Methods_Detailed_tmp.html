<!DOCTYPE html>
<html>
<head>
<title>DiffusionPipeline_Methods_Detailed.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="diffusionpipeline-%E7%B1%BB%E6%96%B9%E6%B3%95%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E">DiffusionPipeline ç±»æ–¹æ³•è¯¦ç»†è¯´æ˜</h1>
<h2 id="%E7%9B%AE%E5%BD%95">ç›®å½•</h2>
<ul>
<li><a href="#%E7%B1%BB%E5%B1%9E%E6%80%A7">ç±»å±æ€§</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95">æ ¸å¿ƒæ–¹æ³•</a></li>
<li><a href="#%E8%AE%BE%E5%A4%87%E5%92%8C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">è®¾å¤‡å’Œå†…å­˜ç®¡ç†</a></li>
<li><a href="#%E6%B3%A8%E6%84%8F%E5%8A%9B%E4%BC%98%E5%8C%96">æ³¨æ„åŠ›ä¼˜åŒ–</a></li>
<li><a href="#vae%E4%BC%98%E5%8C%96">VAEä¼˜åŒ–</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95">å·¥å…·æ–¹æ³•</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD">é«˜çº§åŠŸèƒ½</a></li>
</ul>
<h2 id="%E7%B1%BB%E5%B1%9E%E6%80%A7">ç±»å±æ€§</h2>
<h3 id="%E5%9F%BA%E7%A1%80%E5%B1%9E%E6%80%A7">åŸºç¡€å±æ€§</h3>
<table>
<thead>
<tr>
<th>å±æ€§å</th>
<th>ç±»å‹</th>
<th>é»˜è®¤å€¼</th>
<th>åŸå§‹æè¿°</th>
<th>ä¸­æ–‡è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>config_name</code></td>
<td><code>str</code></td>
<td><code>&quot;model_index.json&quot;</code></td>
<td>The configuration filename that stores the class and module names of all the diffusion pipeline's components.</td>
<td>å­˜å‚¨æ‰©æ•£Pipelineæ‰€æœ‰ç»„ä»¶çš„ç±»åå’Œæ¨¡å—åçš„é…ç½®æ–‡ä»¶å</td>
</tr>
<tr>
<td><code>model_cpu_offload_seq</code></td>
<td><code>Optional[str]</code></td>
<td><code>None</code></td>
<td>-</td>
<td>æ¨¡å‹CPUå¸è½½åºåˆ—ï¼Œå®šä¹‰æ¨¡å‹å¸è½½é¡ºåº</td>
</tr>
<tr>
<td><code>hf_device_map</code></td>
<td><code>Optional[Dict]</code></td>
<td><code>None</code></td>
<td>-</td>
<td>HuggingFaceè®¾å¤‡æ˜ å°„é…ç½®</td>
</tr>
<tr>
<td><code>_optional_components</code></td>
<td><code>List[str]</code></td>
<td><code>[]</code></td>
<td>List of all optional components that don't have to be passed to the pipeline to function (should be overridden by subclasses).</td>
<td>æ‰€æœ‰å¯é€‰ç»„ä»¶çš„åˆ—è¡¨ï¼Œè¿™äº›ç»„ä»¶ä¸å¿…ä¼ é€’ç»™Pipelineå³å¯è¿è¡Œï¼ˆåº”ç”±å­ç±»é‡å†™ï¼‰</td>
</tr>
<tr>
<td><code>_exclude_from_cpu_offload</code></td>
<td><code>List[str]</code></td>
<td><code>[]</code></td>
<td>-</td>
<td>ä»CPUå¸è½½ä¸­æ’é™¤çš„ç»„ä»¶åˆ—è¡¨</td>
</tr>
<tr>
<td><code>_load_connected_pipes</code></td>
<td><code>bool</code></td>
<td><code>False</code></td>
<td>-</td>
<td>æ˜¯å¦åŠ è½½è¿æ¥çš„Pipeline</td>
</tr>
<tr>
<td><code>_is_onnx</code></td>
<td><code>bool</code></td>
<td><code>False</code></td>
<td>-</td>
<td>æ˜¯å¦ä¸ºONNX Pipeline</td>
</tr>
</tbody>
</table>
<h2 id="%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95">æ ¸å¿ƒæ–¹æ³•</h2>
<h3 id="1-init-%E6%96%B9%E6%B3%95">1. <code>__init__</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, *args, **kwargs)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: Pipelineçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œç”±å­ç±»å®ç°å…·ä½“çš„ç»„ä»¶åˆå§‹åŒ–ã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>*args</code>: ä½ç½®å‚æ•°ï¼Œé€šå¸¸åŒ…å«Pipelineçš„å„ä¸ªç»„ä»¶</li>
<li><code>**kwargs</code>: å…³é”®å­—å‚æ•°ï¼Œç”¨äºä¼ é€’é¢å¤–é…ç½®</li>
</ul>
<hr>
<h3 id="2-registermodules-%E6%96%B9%E6%B3%95">2. <code>register_modules</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">register_modules</span><span class="hljs-params">(self, **kwargs)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: æ³¨å†ŒPipelineçš„æ¨¡å—ç»„ä»¶ï¼Œå°†ç»„ä»¶ä¿¡æ¯ä¿å­˜åˆ°é…ç½®ä¸­ã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>**kwargs</code>: è¦æ³¨å†Œçš„æ¨¡å—ï¼Œé”®ä¸ºæ¨¡å—åï¼Œå€¼ä¸ºæ¨¡å—å¯¹è±¡</li>
</ul>
<p><strong>åŠŸèƒ½</strong>:</p>
<ul>
<li>è‡ªåŠ¨æ£€æµ‹æ¨¡å—çš„åº“å’Œç±»å</li>
<li>å°†æ¨¡å—ä¿¡æ¯æ³¨å†Œåˆ°é…ç½®ä¸­</li>
<li>è®¾ç½®æ¨¡å—ä¸ºPipelineçš„å±æ€§</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div>pipeline.register_modules(
    unet=unet_model,
    vae=vae_model,
    scheduler=scheduler
)
</div></code></pre>
<hr>
<h3 id="3-savepretrained-%E6%96%B9%E6%B3%95">3. <code>save_pretrained</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_pretrained</span><span class="hljs-params">(
    self,
    save_directory: Union[str, os.PathLike],
    safe_serialization: bool = True,
    variant: Optional[str] = None,
    max_shard_size: Optional[Union[int, str]] = None,
    push_to_hub: bool = False,
    **kwargs
)</span>
</span></div></code></pre>
<p><strong>åŸå§‹æ–‡æ¡£</strong>: Save all saveable variables of the pipeline to a directory. A pipeline variable can be saved and loaded if its class implements both a save and loading method. The pipeline is easily reloaded using the [<code>~DiffusionPipeline.from_pretrained</code>] class method.</p>
<p><strong>ä¸­æ–‡æè¿°</strong>: å°†Pipelineçš„æ‰€æœ‰å¯ä¿å­˜å˜é‡ä¿å­˜åˆ°ç›®å½•ä¸­ã€‚å¦‚æœPipelineå˜é‡çš„ç±»å®ç°äº†ä¿å­˜å’ŒåŠ è½½æ–¹æ³•ï¼Œåˆ™å¯ä»¥ä¿å­˜å’ŒåŠ è½½è¯¥å˜é‡ã€‚å¯ä»¥ä½¿ç”¨[<code>~DiffusionPipeline.from_pretrained</code>]ç±»æ–¹æ³•è½»æ¾é‡æ–°åŠ è½½Pipelineã€‚</p>
<p><strong>å‚æ•°è¯¦è§£</strong>:</p>
<ul>
<li><code>save_directory</code> (<code>str</code> or <code>os.PathLike</code>): Directory to save a pipeline to. Will be created if it doesn't exist. | ä¿å­˜Pipelineçš„ç›®å½•ï¼Œå¦‚æœä¸å­˜åœ¨å°†è¢«åˆ›å»º</li>
<li><code>safe_serialization</code> (<code>bool</code>, <em>optional</em>, defaults to <code>True</code>): Whether to save the model using <code>safetensors</code> or the traditional PyTorch way with <code>pickle</code>. | æ˜¯å¦ä½¿ç”¨<code>safetensors</code>ä¿å­˜æ¨¡å‹ï¼Œæˆ–ä½¿ç”¨ä¼ ç»Ÿçš„PyTorchæ–¹å¼ä¸<code>pickle</code></li>
<li><code>variant</code> (<code>str</code>, <em>optional</em>): If specified, weights are saved in the format <code>pytorch_model.&lt;variant&gt;.bin</code>. | å¦‚æœæŒ‡å®šï¼Œæƒé‡å°†ä»¥<code>pytorch_model.&lt;variant&gt;.bin</code>æ ¼å¼ä¿å­˜</li>
<li><code>max_shard_size</code> (<code>int</code> or <code>str</code>, defaults to <code>None</code>): The maximum size for a checkpoint before being sharded. | åˆ†ç‰‡å‰æ£€æŸ¥ç‚¹çš„æœ€å¤§å¤§å°</li>
<li><code>push_to_hub</code> (<code>bool</code>, <em>optional</em>, defaults to <code>False</code>): Whether or not to push your model to the Hugging Face model hub after saving it. | ä¿å­˜åæ˜¯å¦å°†æ¨¡å‹æ¨é€åˆ°Hugging Faceæ¨¡å‹ä¸­å¿ƒ</li>
<li><code>**kwargs</code> (<code>Dict[str, Any]</code>, <em>optional</em>): Additional keyword arguments passed along to the [<code>~utils.PushToHubMixin.push_to_hub</code>] method. | ä¼ é€’ç»™[<code>~utils.PushToHubMixin.push_to_hub</code>]æ–¹æ³•çš„é¢å¤–å…³é”®å­—å‚æ•°</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># åŸºç¡€ä¿å­˜</span>
pipeline.save_pretrained(<span class="hljs-string">"./my_pipeline"</span>)

<span class="hljs-comment"># ä¿å­˜fp16å˜ä½“å¹¶æ¨é€åˆ°Hub</span>
pipeline.save_pretrained(
    <span class="hljs-string">"./my_pipeline"</span>,
    variant=<span class="hljs-string">"fp16"</span>,
    push_to_hub=<span class="hljs-literal">True</span>,
    repo_id=<span class="hljs-string">"my_username/my_pipeline"</span>
)
</div></code></pre>
<hr>
<h3 id="4-frompretrained-%E7%B1%BB%E6%96%B9%E6%B3%95">4. <code>from_pretrained</code> ç±»æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-meta">@classmethod</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">from_pretrained</span><span class="hljs-params">(
    cls, 
    pretrained_model_name_or_path: Optional[Union[str, os.PathLike]], 
    **kwargs
)</span> -&gt; Self
</span></div></code></pre>
<p><strong>æè¿°</strong>: ä»é¢„è®­ç»ƒæƒé‡å®ä¾‹åŒ–PyTorchæ‰©æ•£Pipelineã€‚</p>
<p><strong>æ ¸å¿ƒå‚æ•°</strong>:</p>
<ul>
<li><code>pretrained_model_name_or_path</code> (<code>str</code> | <code>os.PathLike</code>):
<ul>
<li>Hubä»“åº“ID (å¦‚ <code>&quot;CompVis/ldm-text2im-large-256&quot;</code>)</li>
<li>æœ¬åœ°ç›®å½•è·¯å¾„ (å¦‚ <code>&quot;./my_pipeline_directory/&quot;</code>)</li>
<li>DDUFæ–‡ä»¶è·¯å¾„</li>
</ul>
</li>
</ul>
<p><strong>æ•°æ®ç±»å‹å‚æ•°</strong>:</p>
<ul>
<li><code>torch_dtype</code> (<code>torch.dtype</code> | <code>dict</code>):
<ul>
<li>å•ä¸€ç±»å‹: <code>torch.float16</code></li>
<li>ç»„ä»¶ç‰¹å®š: <code>{'transformer': torch.bfloat16, 'vae': torch.float16}</code></li>
<li>å¸¦é»˜è®¤å€¼: <code>{'transformer': torch.bfloat16, 'default': torch.float16}</code></li>
</ul>
</li>
</ul>
<p><strong>è‡ªå®šä¹‰Pipelineå‚æ•°</strong>:</p>
<ul>
<li><code>custom_pipeline</code> (<code>str</code>):
<ul>
<li>Hubä»“åº“ID: <code>&quot;hf-internal-testing/diffusers-dummy-pipeline&quot;</code></li>
<li>ç¤¾åŒºPipelineå: <code>&quot;clip_guided_stable_diffusion&quot;</code></li>
<li>æœ¬åœ°ç›®å½•: <code>&quot;./my_pipeline_directory/&quot;</code></li>
</ul>
</li>
</ul>
<p><strong>ä¸‹è½½æ§åˆ¶å‚æ•°</strong>:</p>
<ul>
<li><code>force_download</code> (<code>bool</code>, é»˜è®¤ <code>False</code>): å¼ºåˆ¶é‡æ–°ä¸‹è½½</li>
<li><code>cache_dir</code> (<code>str</code>): ç¼“å­˜ç›®å½•è·¯å¾„</li>
<li><code>local_files_only</code> (<code>bool</code>, é»˜è®¤ <code>False</code>): ä»…ä½¿ç”¨æœ¬åœ°æ–‡ä»¶</li>
<li><code>token</code> (<code>str</code> | <code>bool</code>): HuggingFaceè®¿é—®ä»¤ç‰Œ</li>
<li><code>revision</code> (<code>str</code>, é»˜è®¤ <code>&quot;main&quot;</code>): æ¨¡å‹ç‰ˆæœ¬åˆ†æ”¯/æ ‡ç­¾/æäº¤ID</li>
<li><code>custom_revision</code> (<code>str</code>): è‡ªå®šä¹‰Pipelineçš„ç‰ˆæœ¬</li>
</ul>
<p><strong>ç½‘ç»œå‚æ•°</strong>:</p>
<ul>
<li><code>proxies</code> (<code>Dict[str, str]</code>): ä»£ç†æœåŠ¡å™¨é…ç½®</li>
<li><code>mirror</code> (<code>str</code>): é•œåƒæºåœ°å€ï¼ˆä¸­å›½ç”¨æˆ·ï¼‰</li>
</ul>
<p><strong>è®¾å¤‡æ˜ å°„å‚æ•°</strong>:</p>
<ul>
<li><code>device_map</code> (<code>str</code>): è®¾å¤‡æ˜ å°„ç­–ç•¥ï¼Œç›®å‰æ”¯æŒ&quot;balanced&quot;</li>
<li><code>max_memory</code> (<code>Dict</code>): æ¯ä¸ªè®¾å¤‡çš„æœ€å¤§å†…å­˜é™åˆ¶</li>
<li><code>offload_folder</code> (<code>str</code>): ç£ç›˜å¸è½½ç›®å½•</li>
<li><code>offload_state_dict</code> (<code>bool</code>): æ˜¯å¦ä¸´æ—¶å¸è½½CPUçŠ¶æ€å­—å…¸</li>
</ul>
<p><strong>å†…å­˜ä¼˜åŒ–å‚æ•°</strong>:</p>
<ul>
<li><code>low_cpu_mem_usage</code> (<code>bool</code>): ä½CPUå†…å­˜ä½¿ç”¨æ¨¡å¼</li>
<li><code>use_safetensors</code> (<code>bool</code>): æ˜¯å¦ä½¿ç”¨safetensorsæ ¼å¼</li>
<li><code>use_onnx</code> (<code>bool</code>): æ˜¯å¦ä½¿ç”¨ONNXæƒé‡</li>
<li><code>variant</code> (<code>str</code>): æƒé‡å˜ä½“ï¼Œå¦‚&quot;fp16&quot;</li>
<li><code>dduf_file</code> (<code>str</code>): DDUFæ–‡ä»¶è·¯å¾„</li>
</ul>
<p><strong>å…¶ä»–å‚æ•°</strong>:</p>
<ul>
<li><code>output_loading_info</code> (<code>bool</code>, é»˜è®¤ <code>False</code>): è¿”å›åŠ è½½ä¿¡æ¯</li>
<li><code>quantization_config</code>: é‡åŒ–é…ç½®</li>
<li><code>**kwargs</code>: è¦†ç›–Pipelineç»„ä»¶çš„å‚æ•°</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># åŸºç¡€åŠ è½½</span>
pipeline = DiffusionPipeline.from_pretrained(<span class="hljs-string">"stable-diffusion-v1-5/stable-diffusion-v1-5"</span>)

<span class="hljs-comment"># æŒ‡å®šæ•°æ®ç±»å‹å’Œè®¾å¤‡</span>
pipeline = DiffusionPipeline.from_pretrained(
    <span class="hljs-string">"stabilityai/stable-diffusion-xl-base-1.0"</span>,
    torch_dtype=torch.float16,
    device_map=<span class="hljs-string">"balanced"</span>,
    use_safetensors=<span class="hljs-literal">True</span>
)

<span class="hljs-comment"># ç»„ä»¶ç‰¹å®šæ•°æ®ç±»å‹</span>
pipeline = DiffusionPipeline.from_pretrained(
    <span class="hljs-string">"black-forest-labs/FLUX.1-schnell"</span>,
    torch_dtype={
        <span class="hljs-string">'transformer'</span>: torch.bfloat16,
        <span class="hljs-string">'vae'</span>: torch.float16,
        <span class="hljs-string">'default'</span>: torch.float32
    }
)

<span class="hljs-comment"># ä½¿ç”¨è‡ªå®šä¹‰è°ƒåº¦å™¨</span>
<span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> LMSDiscreteScheduler
pipeline = DiffusionPipeline.from_pretrained(
    <span class="hljs-string">"stable-diffusion-v1-5/stable-diffusion-v1-5"</span>,
    scheduler=LMSDiscreteScheduler.from_config(scheduler_config)
)
</div></code></pre>
<hr>
<h3 id="5-to-%E6%96%B9%E6%B3%95">5. <code>to</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">to</span><span class="hljs-params">(self, *args, **kwargs)</span> -&gt; Self
</span></div></code></pre>
<p><strong>æè¿°</strong>: æ‰§è¡ŒPipelineçš„æ•°æ®ç±»å‹å’Œ/æˆ–è®¾å¤‡è½¬æ¢ã€‚</p>
<p><strong>è°ƒç”¨æ–¹å¼</strong>:</p>
<ul>
<li><code>to(dtype)</code>: è½¬æ¢åˆ°æŒ‡å®šæ•°æ®ç±»å‹</li>
<li><code>to(device)</code>: è½¬æ¢åˆ°æŒ‡å®šè®¾å¤‡</li>
<li><code>to(device, dtype)</code>: åŒæ—¶è½¬æ¢è®¾å¤‡å’Œæ•°æ®ç±»å‹</li>
<li><code>to(device=None, dtype=None, silence_dtype_warnings=False)</code>: å…³é”®å­—å‚æ•°æ–¹å¼</li>
</ul>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>dtype</code> (<code>torch.dtype</code>, å¯é€‰): ç›®æ ‡æ•°æ®ç±»å‹</li>
<li><code>device</code> (<code>torch.device</code>, å¯é€‰): ç›®æ ‡è®¾å¤‡</li>
<li><code>silence_dtype_warnings</code> (<code>bool</code>, é»˜è®¤ <code>False</code>): æ˜¯å¦é™é»˜æ•°æ®ç±»å‹è­¦å‘Š</li>
</ul>
<p><strong>è¿”å›å€¼</strong>: è½¬æ¢åçš„Pipelineå®ä¾‹ï¼ˆå¦‚æœå·²ç»æ˜¯ç›®æ ‡ç±»å‹åˆ™è¿”å›è‡ªèº«ï¼‰</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ç§»åŠ¨åˆ°GPU</span>
pipeline = pipeline.to(<span class="hljs-string">"cuda"</span>)

<span class="hljs-comment"># è½¬æ¢æ•°æ®ç±»å‹</span>
pipeline = pipeline.to(torch.float16)

<span class="hljs-comment"># åŒæ—¶è½¬æ¢è®¾å¤‡å’Œæ•°æ®ç±»å‹</span>
pipeline = pipeline.to(<span class="hljs-string">"cuda"</span>, torch.float16)

<span class="hljs-comment"># é™é»˜è­¦å‘Š</span>
pipeline = pipeline.to(<span class="hljs-string">"cuda"</span>, silence_dtype_warnings=<span class="hljs-literal">True</span>)
</div></code></pre>
<hr>
<h3 id="6-download-%E7%B1%BB%E6%96%B9%E6%B3%95">6. <code>download</code> ç±»æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-meta">@classmethod</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download</span><span class="hljs-params">(cls, pretrained_model_name, **kwargs)</span> -&gt; Union[str, os.PathLike]
</span></div></code></pre>
<p><strong>æè¿°</strong>: ä¸‹è½½å¹¶ç¼“å­˜PyTorchæ‰©æ•£Pipelineï¼Œä½†ä¸å®ä¾‹åŒ–ã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>pretrained_model_name</code> (<code>str</code>): Hubä»“åº“ID</li>
<li><code>custom_pipeline</code> (<code>str</code>, å¯é€‰): è‡ªå®šä¹‰Pipeline</li>
<li><code>force_download</code> (<code>bool</code>, é»˜è®¤ <code>False</code>): å¼ºåˆ¶é‡æ–°ä¸‹è½½</li>
<li><code>proxies</code> (<code>Dict[str, str]</code>, å¯é€‰): ä»£ç†é…ç½®</li>
<li><code>output_loading_info</code> (<code>bool</code>, é»˜è®¤ <code>False</code>): è¿”å›åŠ è½½ä¿¡æ¯</li>
<li><code>local_files_only</code> (<code>bool</code>, é»˜è®¤ <code>False</code>): ä»…ä½¿ç”¨æœ¬åœ°æ–‡ä»¶</li>
<li><code>token</code> (<code>str</code> | <code>bool</code>, å¯é€‰): è®¿é—®ä»¤ç‰Œ</li>
<li><code>revision</code> (<code>str</code>, é»˜è®¤ <code>&quot;main&quot;</code>): ç‰ˆæœ¬</li>
</ul>
<p><strong>è¿”å›å€¼</strong>: ä¸‹è½½çš„æ¨¡å‹è·¯å¾„</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ä¸‹è½½æ¨¡å‹åˆ°ç¼“å­˜</span>
model_path = DiffusionPipeline.download(<span class="hljs-string">"stable-diffusion-v1-5/stable-diffusion-v1-5"</span>)
print(<span class="hljs-string">f"æ¨¡å‹ä¸‹è½½åˆ°: <span class="hljs-subst">{model_path}</span>"</span>)
</div></code></pre>
<h2 id="%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E5%99%A8">å±æ€§è®¿é—®å™¨</h2>
<h3 id="7-device-%E5%B1%9E%E6%80%A7">7. <code>device</code> å±æ€§</h3>
<pre class="hljs"><code><div><span class="hljs-meta">@property</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">device</span><span class="hljs-params">(self)</span> -&gt; torch.device
</span></div></code></pre>
<p><strong>æè¿°</strong>: è¿”å›Pipelineæ‰€åœ¨çš„torchè®¾å¤‡ã€‚</p>
<p><strong>è¿”å›å€¼</strong>: Pipelineå½“å‰æ‰€åœ¨çš„è®¾å¤‡</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div>print(<span class="hljs-string">f"Pipelineåœ¨è®¾å¤‡: <span class="hljs-subst">{pipeline.device}</span>"</span>)
<span class="hljs-comment"># è¾“å‡º: Pipelineåœ¨è®¾å¤‡: cuda:0</span>
</div></code></pre>
<hr>
<h3 id="8-dtype-%E5%B1%9E%E6%80%A7">8. <code>dtype</code> å±æ€§</h3>
<pre class="hljs"><code><div><span class="hljs-meta">@property</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dtype</span><span class="hljs-params">(self)</span> -&gt; torch.dtype
</span></div></code></pre>
<p><strong>æè¿°</strong>: è¿”å›Pipelineçš„torchæ•°æ®ç±»å‹ã€‚</p>
<p><strong>è¿”å›å€¼</strong>: Pipelineçš„æ•°æ®ç±»å‹</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div>print(<span class="hljs-string">f"Pipelineæ•°æ®ç±»å‹: <span class="hljs-subst">{pipeline.dtype}</span>"</span>)
<span class="hljs-comment"># è¾“å‡º: Pipelineæ•°æ®ç±»å‹: torch.float16</span>
</div></code></pre>
<hr>
<h3 id="9-components-%E5%B1%9E%E6%80%A7">9. <code>components</code> å±æ€§</h3>
<pre class="hljs"><code><div><span class="hljs-meta">@property</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">components</span><span class="hljs-params">(self)</span> -&gt; Dict[str, Any]
</span></div></code></pre>
<p><strong>æè¿°</strong>: è¿”å›Pipelineçš„æ‰€æœ‰ç»„ä»¶å­—å…¸ï¼Œç”¨äºåœ¨ä¸åŒPipelineé—´å…±äº«æƒé‡å’Œé…ç½®ã€‚</p>
<p><strong>è¿”å›å€¼</strong>: åŒ…å«æ‰€æœ‰Pipelineç»„ä»¶çš„å­—å…¸</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div>components = pipeline.components
print(<span class="hljs-string">"Pipelineç»„ä»¶:"</span>, list(components.keys()))
<span class="hljs-comment"># è¾“å‡º: Pipelineç»„ä»¶: ['vae', 'text_encoder', 'tokenizer', 'unet', 'scheduler']</span>

<span class="hljs-comment"># ä½¿ç”¨ç»„ä»¶åˆ›å»ºæ–°Pipeline</span>
new_pipeline = AnotherPipeline(**components)
</div></code></pre>
<hr>
<h3 id="10-nameorpath-%E5%B1%9E%E6%80%A7">10. <code>name_or_path</code> å±æ€§</h3>
<pre class="hljs"><code><div><span class="hljs-meta">@property</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">name_or_path</span><span class="hljs-params">(self)</span> -&gt; str
</span></div></code></pre>
<p><strong>æè¿°</strong>: è¿”å›Pipelineçš„åç§°æˆ–è·¯å¾„ã€‚</p>
<p><strong>è¿”å›å€¼</strong>: Pipelineçš„åŸå§‹åç§°æˆ–è·¯å¾„</p>
<h2 id="%E8%AE%BE%E5%A4%87%E5%92%8C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">è®¾å¤‡å’Œå†…å­˜ç®¡ç†</h2>
<h3 id="11-enablemodelcpuoffload-%E6%96%B9%E6%B3%95">11. <code>enable_model_cpu_offload</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enable_model_cpu_offload</span><span class="hljs-params">(self, gpu_id: Optional[int] = None, device: Union[torch.device, str] = None)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: ä½¿ç”¨accelerateå°†æ‰€æœ‰æ¨¡å‹å¸è½½åˆ°CPUï¼Œä»¥è¾ƒä½çš„æ€§èƒ½å½±å“å‡å°‘å†…å­˜ä½¿ç”¨ã€‚ä¸<code>enable_sequential_cpu_offload</code>ç›¸æ¯”ï¼Œæ­¤æ–¹æ³•åœ¨è°ƒç”¨<code>forward</code>æ–¹æ³•æ—¶å°†æ•´ä¸ªæ¨¡å‹ç§»åŠ¨åˆ°åŠ é€Ÿå™¨ï¼Œæ¨¡å‹ä¿æŒåœ¨åŠ é€Ÿå™¨ä¸Šç›´åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹è¿è¡Œã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>gpu_id</code> (<code>int</code>, å¯é€‰): æ¨ç†æ—¶ä½¿ç”¨çš„åŠ é€Ÿå™¨IDï¼Œé»˜è®¤ä¸º0</li>
<li><code>device</code> (<code>torch.device</code> | <code>str</code>, å¯é€‰): æ¨ç†æ—¶ä½¿ç”¨çš„PyTorchè®¾å¤‡ç±»å‹ï¼Œè‡ªåŠ¨æ£€æµ‹å¯ç”¨åŠ é€Ÿå™¨</li>
</ul>
<p><strong>ç‰¹ç‚¹</strong>:</p>
<ul>
<li>å†…å­˜èŠ‚çœä½äº<code>enable_sequential_cpu_offload</code></li>
<li>æ€§èƒ½å½±å“è¾ƒå°ï¼Œå› ä¸ºUNetçš„è¿­ä»£æ‰§è¡Œ</li>
<li>é€‚åˆéœ€è¦å¹³è¡¡å†…å­˜å’Œæ€§èƒ½çš„åœºæ™¯</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ä½¿ç”¨é»˜è®¤GPU</span>
pipeline.enable_model_cpu_offload()

<span class="hljs-comment"># æŒ‡å®šGPU ID</span>
pipeline.enable_model_cpu_offload(gpu_id=<span class="hljs-number">1</span>)

<span class="hljs-comment"># æŒ‡å®šè®¾å¤‡</span>
pipeline.enable_model_cpu_offload(device=<span class="hljs-string">"cuda:1"</span>)
</div></code></pre>
<hr>
<h3 id="12-enablesequentialcpuoffload-%E6%96%B9%E6%B3%95">12. <code>enable_sequential_cpu_offload</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enable_sequential_cpu_offload</span><span class="hljs-params">(self, gpu_id: Optional[int] = None, device: Union[torch.device, str] = None)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: ä½¿ç”¨ğŸ¤— Accelerateå°†æ‰€æœ‰æ¨¡å‹å¸è½½åˆ°CPUï¼Œæ˜¾è‘—å‡å°‘å†…å­˜ä½¿ç”¨ã€‚æ‰€æœ‰<code>torch.nn.Module</code>ç»„ä»¶çš„çŠ¶æ€å­—å…¸ä¿å­˜åˆ°CPUï¼Œç„¶åç§»åŠ¨åˆ°<code>torch.device('meta')</code>ï¼Œä»…åœ¨ç‰¹å®šå­æ¨¡å—è°ƒç”¨<code>forward</code>æ–¹æ³•æ—¶åŠ è½½åˆ°åŠ é€Ÿå™¨ã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>gpu_id</code> (<code>int</code>, å¯é€‰): æ¨ç†æ—¶ä½¿ç”¨çš„åŠ é€Ÿå™¨IDï¼Œé»˜è®¤ä¸º0</li>
<li><code>device</code> (<code>torch.device</code> | <code>str</code>, å¯é€‰): æ¨ç†æ—¶ä½¿ç”¨çš„PyTorchè®¾å¤‡ç±»å‹</li>
</ul>
<p><strong>ç‰¹ç‚¹</strong>:</p>
<ul>
<li>å†…å­˜èŠ‚çœé«˜äº<code>enable_model_cpu_offload</code></li>
<li>æ€§èƒ½å½±å“è¾ƒå¤§ï¼Œå› ä¸ºå­æ¨¡å—çº§åˆ«çš„å¸è½½</li>
<li>é€‚åˆå†…å­˜æåº¦å—é™çš„åœºæ™¯</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># å¯ç”¨é¡ºåºCPUå¸è½½</span>
pipeline.enable_sequential_cpu_offload()

<span class="hljs-comment"># æŒ‡å®šè®¾å¤‡</span>
pipeline.enable_sequential_cpu_offload(device=<span class="hljs-string">"cuda:0"</span>)
</div></code></pre>
<hr>
<h3 id="13-removeallhooks-%E6%96%B9%E6%B3%95">13. <code>remove_all_hooks</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">remove_all_hooks</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: ç§»é™¤ä½¿ç”¨<code>enable_sequential_cpu_offload</code>æˆ–<code>enable_model_cpu_offload</code>æ—¶æ·»åŠ çš„æ‰€æœ‰é’©å­ã€‚</p>
<p><strong>åŠŸèƒ½</strong>:</p>
<ul>
<li>æ¸…ç†æ‰€æœ‰accelerateé’©å­</li>
<li>æ¢å¤æ¨¡å‹åˆ°æ­£å¸¸çŠ¶æ€</li>
<li>é‡Šæ”¾é’©å­å ç”¨çš„èµ„æº</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ç§»é™¤æ‰€æœ‰å¸è½½é’©å­</span>
pipeline.remove_all_hooks()
</div></code></pre>
<hr>
<h3 id="14-maybefreemodelhooks-%E6%96%B9%E6%B3%95">14. <code>maybe_free_model_hooks</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">maybe_free_model_hooks</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: æ‰§è¡Œä»¥ä¸‹æ“ä½œçš„æ–¹æ³•ï¼š</p>
<ul>
<li>å¸è½½æ‰€æœ‰ç»„ä»¶</li>
<li>ç§»é™¤ä½¿ç”¨<code>enable_model_cpu_offload</code>æ—¶æ·»åŠ çš„æ‰€æœ‰æ¨¡å‹é’©å­ï¼Œç„¶åé‡æ–°åº”ç”¨</li>
<li>é‡ç½®å»å™ªå™¨ç»„ä»¶çš„æœ‰çŠ¶æ€æ‰©æ•£é’©å­</li>
</ul>
<p><strong>ç”¨é€”</strong>: åœ¨Pipelineçš„<code>__call__</code>å‡½æ•°æœ«å°¾æ·»åŠ æ­¤å‡½æ•°ï¼Œç¡®ä¿åœ¨åº”ç”¨<code>enable_model_cpu_offload</code>æ—¶æ­£å¸¸å·¥ä½œã€‚</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># é€šå¸¸åœ¨Pipelineå†…éƒ¨è°ƒç”¨</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span><span class="hljs-params">(self, *args, **kwargs)</span>:</span>
    <span class="hljs-comment"># ... Pipelineé€»è¾‘ ...</span>
    self.maybe_free_model_hooks()
    <span class="hljs-keyword">return</span> result
</div></code></pre>
<hr>
<h3 id="15-resetdevicemap-%E6%96%B9%E6%B3%95">15. <code>reset_device_map</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_device_map</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å°†è®¾å¤‡æ˜ å°„ï¼ˆå¦‚æœæœ‰ï¼‰é‡ç½®ä¸ºNoneã€‚</p>
<p><strong>åŠŸèƒ½</strong>:</p>
<ul>
<li>ç§»é™¤æ‰€æœ‰é’©å­</li>
<li>å°†æ‰€æœ‰ç»„ä»¶ç§»åŠ¨åˆ°CPU</li>
<li>æ¸…ç©ºè®¾å¤‡æ˜ å°„é…ç½®</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># é‡ç½®è®¾å¤‡æ˜ å°„</span>
pipeline.reset_device_map()
</div></code></pre>
<h2 id="%E6%B3%A8%E6%84%8F%E5%8A%9B%E4%BC%98%E5%8C%96">æ³¨æ„åŠ›ä¼˜åŒ–</h2>
<h3 id="16-enablexformersmemoryefficientattention-%E6%96%B9%E6%B3%95">16. <code>enable_xformers_memory_efficient_attention</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enable_xformers_memory_efficient_attention</span><span class="hljs-params">(self, attention_op: Optional[Callable] = None)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å¯ç”¨æ¥è‡ªxFormersçš„å†…å­˜é«˜æ•ˆæ³¨æ„åŠ›ã€‚å¯ç”¨æ­¤é€‰é¡¹æ—¶ï¼Œåº”è¯¥è§‚å¯Ÿåˆ°æ›´ä½çš„GPUå†…å­˜ä½¿ç”¨å’Œæ¨ç†æœŸé—´çš„æ½œåœ¨åŠ é€Ÿã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>attention_op</code> (<code>Callable</code>, å¯é€‰): è¦†ç›–é»˜è®¤çš„<code>None</code>æ“ä½œç¬¦ï¼Œç”¨ä½œxFormersçš„<code>memory_efficient_attention()</code>å‡½æ•°çš„<code>op</code>å‚æ•°</li>
</ul>
<p><strong>æ³¨æ„äº‹é¡¹</strong>:</p>
<ul>
<li>âš ï¸ å½“å†…å­˜é«˜æ•ˆæ³¨æ„åŠ›å’Œåˆ‡ç‰‡æ³¨æ„åŠ›éƒ½å¯ç”¨æ—¶ï¼Œå†…å­˜é«˜æ•ˆæ³¨æ„åŠ›ä¼˜å…ˆ</li>
<li>è®­ç»ƒæœŸé—´çš„åŠ é€Ÿä¸ä¿è¯</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># å¯ç”¨xFormerså†…å­˜é«˜æ•ˆæ³¨æ„åŠ›</span>
pipeline.enable_xformers_memory_efficient_attention()

<span class="hljs-comment"># ä½¿ç”¨ç‰¹å®šæ“ä½œç¬¦</span>
<span class="hljs-keyword">from</span> xformers.ops <span class="hljs-keyword">import</span> MemoryEfficientAttentionFlashAttentionOp
pipeline.enable_xformers_memory_efficient_attention(
    attention_op=MemoryEfficientAttentionFlashAttentionOp
)

<span class="hljs-comment"># VAEçš„Flash Attentionå˜é€šæ–¹æ¡ˆ</span>
pipeline.vae.enable_xformers_memory_efficient_attention(attention_op=<span class="hljs-literal">None</span>)
</div></code></pre>
<hr>
<h3 id="17-disablexformersmemoryefficientattention-%E6%96%B9%E6%B3%95">17. <code>disable_xformers_memory_efficient_attention</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">disable_xformers_memory_efficient_attention</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: ç¦ç”¨æ¥è‡ªxFormersçš„å†…å­˜é«˜æ•ˆæ³¨æ„åŠ›ã€‚</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ç¦ç”¨xFormerså†…å­˜é«˜æ•ˆæ³¨æ„åŠ›</span>
pipeline.disable_xformers_memory_efficient_attention()
</div></code></pre>
<hr>
<h3 id="18-enableattentionslicing-%E6%96%B9%E6%B3%95">18. <code>enable_attention_slicing</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enable_attention_slicing</span><span class="hljs-params">(self, slice_size: Optional[Union[str, int]] = <span class="hljs-string">"auto"</span>)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å¯ç”¨åˆ‡ç‰‡æ³¨æ„åŠ›è®¡ç®—ã€‚å¯ç”¨æ­¤é€‰é¡¹æ—¶ï¼Œæ³¨æ„åŠ›æ¨¡å—å°†è¾“å…¥å¼ é‡åˆ†å‰²æˆåˆ‡ç‰‡ï¼Œåˆ†å‡ ä¸ªæ­¥éª¤è®¡ç®—æ³¨æ„åŠ›ã€‚å¯¹äºå¤šä¸ªæ³¨æ„åŠ›å¤´ï¼Œè®¡ç®—åœ¨æ¯ä¸ªå¤´ä¸Šé¡ºåºæ‰§è¡Œã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>slice_size</code> (<code>str</code> | <code>int</code>, é»˜è®¤ <code>&quot;auto&quot;</code>):
<ul>
<li><code>&quot;auto&quot;</code>: å°†æ³¨æ„åŠ›å¤´çš„è¾“å…¥å‡åŠï¼Œæ³¨æ„åŠ›å°†åˆ†ä¸¤æ­¥è®¡ç®—</li>
<li><code>&quot;max&quot;</code>: é€šè¿‡ä¸€æ¬¡åªè¿è¡Œä¸€ä¸ªåˆ‡ç‰‡æ¥èŠ‚çœæœ€å¤§å†…å­˜</li>
<li>æ•°å­—: ä½¿ç”¨<code>attention_head_dim // slice_size</code>ä¸ªåˆ‡ç‰‡ï¼Œ<code>attention_head_dim</code>å¿…é¡»æ˜¯<code>slice_size</code>çš„å€æ•°</li>
</ul>
</li>
</ul>
<p><strong>æ³¨æ„äº‹é¡¹</strong>:</p>
<ul>
<li>âš ï¸ å¦‚æœå·²ç»ä½¿ç”¨PyTorch 2.0çš„<code>scaled_dot_product_attention</code>(SDPA)æˆ–xFormersï¼Œä¸è¦å¯ç”¨æ³¨æ„åŠ›åˆ‡ç‰‡</li>
<li>è¿™äº›æ³¨æ„åŠ›è®¡ç®—å·²ç»éå¸¸å†…å­˜é«˜æ•ˆï¼Œå¯ç”¨åˆ‡ç‰‡å¯èƒ½å¯¼è‡´ä¸¥é‡å‡é€Ÿ</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># è‡ªåŠ¨åˆ‡ç‰‡</span>
pipeline.enable_attention_slicing()

<span class="hljs-comment"># æœ€å¤§å†…å­˜èŠ‚çœ</span>
pipeline.enable_attention_slicing(<span class="hljs-string">"max"</span>)

<span class="hljs-comment"># è‡ªå®šä¹‰åˆ‡ç‰‡å¤§å°</span>
pipeline.enable_attention_slicing(<span class="hljs-number">4</span>)
</div></code></pre>
<hr>
<h3 id="19-disableattentionslicing-%E6%96%B9%E6%B3%95">19. <code>disable_attention_slicing</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">disable_attention_slicing</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: ç¦ç”¨åˆ‡ç‰‡æ³¨æ„åŠ›è®¡ç®—ã€‚å¦‚æœä¹‹å‰è°ƒç”¨äº†<code>enable_attention_slicing</code>ï¼Œæ³¨æ„åŠ›å°†åœ¨ä¸€æ­¥ä¸­è®¡ç®—ã€‚</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ç¦ç”¨æ³¨æ„åŠ›åˆ‡ç‰‡</span>
pipeline.disable_attention_slicing()
</div></code></pre>
<hr>
<h3 id="20-setattentionslice-%E6%96%B9%E6%B3%95">20. <code>set_attention_slice</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_attention_slice</span><span class="hljs-params">(self, slice_size: Optional[int])</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: è®¾ç½®æ³¨æ„åŠ›åˆ‡ç‰‡å¤§å°çš„å†…éƒ¨æ–¹æ³•ã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>slice_size</code> (<code>int</code>, å¯é€‰): åˆ‡ç‰‡å¤§å°ï¼Œ<code>None</code>è¡¨ç¤ºç¦ç”¨åˆ‡ç‰‡</li>
</ul>
<p><strong>åŠŸèƒ½</strong>: éå†æ‰€æœ‰æ”¯æŒæ³¨æ„åŠ›åˆ‡ç‰‡çš„æ¨¡å—å¹¶è®¾ç½®åˆ‡ç‰‡å¤§å°</p>
<h2 id="vae%E4%BC%98%E5%8C%96">VAEä¼˜åŒ–</h2>
<h3 id="21-enablevaeslicing-%E6%96%B9%E6%B3%95">21. <code>enable_vae_slicing</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enable_vae_slicing</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å¯ç”¨åˆ‡ç‰‡VAEè§£ç ã€‚å¯ç”¨æ­¤é€‰é¡¹æ—¶ï¼ŒVAEå°†è¾“å…¥å¼ é‡åˆ†å‰²æˆåˆ‡ç‰‡ï¼Œåˆ†å‡ ä¸ªæ­¥éª¤è®¡ç®—è§£ç ã€‚è¿™å¯¹èŠ‚çœå†…å­˜å’Œå…è®¸æ›´å¤§çš„æ‰¹æ¬¡å¤§å°å¾ˆæœ‰ç”¨ã€‚</p>
<p><strong>ç‰¹ç‚¹</strong>:</p>
<ul>
<li>å†…å­˜èŠ‚çœï¼šä¸­ç­‰</li>
<li>æ€§èƒ½å½±å“ï¼šå¾ˆå°</li>
<li>é€‚ç”¨åœºæ™¯ï¼šéœ€è¦å¤„ç†å¤§æ‰¹æ¬¡æˆ–é«˜åˆ†è¾¨ç‡å›¾åƒ</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># å¯ç”¨VAEåˆ‡ç‰‡</span>
pipeline.enable_vae_slicing()
</div></code></pre>
<hr>
<h3 id="22-disablevaeslicing-%E6%96%B9%E6%B3%95">22. <code>disable_vae_slicing</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">disable_vae_slicing</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: ç¦ç”¨åˆ‡ç‰‡VAEè§£ç ã€‚å¦‚æœä¹‹å‰å¯ç”¨äº†<code>enable_vae_slicing</code>ï¼Œæ­¤æ–¹æ³•å°†å›åˆ°ä¸€æ­¥è®¡ç®—è§£ç ã€‚</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ç¦ç”¨VAEåˆ‡ç‰‡</span>
pipeline.disable_vae_slicing()
</div></code></pre>
<hr>
<h3 id="23-enablevaetiling-%E6%96%B9%E6%B3%95">23. <code>enable_vae_tiling</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enable_vae_tiling</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å¯ç”¨å¹³é“ºVAEè§£ç ã€‚å¯ç”¨æ­¤é€‰é¡¹æ—¶ï¼ŒVAEå°†è¾“å…¥å¼ é‡åˆ†å‰²æˆç“¦ç‰‡ï¼Œåˆ†å‡ ä¸ªæ­¥éª¤è®¡ç®—è§£ç å’Œç¼–ç ã€‚è¿™å¯¹èŠ‚çœå¤§é‡å†…å­˜å’Œå…è®¸å¤„ç†æ›´å¤§å›¾åƒéå¸¸æœ‰ç”¨ã€‚</p>
<p><strong>ç‰¹ç‚¹</strong>:</p>
<ul>
<li>å†…å­˜èŠ‚çœï¼šé«˜</li>
<li>æ€§èƒ½å½±å“ï¼šè½»å¾®</li>
<li>é€‚ç”¨åœºæ™¯ï¼šå¤„ç†è¶…é«˜åˆ†è¾¨ç‡å›¾åƒæˆ–å†…å­˜ä¸¥é‡å—é™</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># å¯ç”¨VAEå¹³é“º</span>
pipeline.enable_vae_tiling()
</div></code></pre>
<hr>
<h3 id="24-disablevaetiling-%E6%96%B9%E6%B3%95">24. <code>disable_vae_tiling</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">disable_vae_tiling</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: ç¦ç”¨å¹³é“ºVAEè§£ç ã€‚å¦‚æœä¹‹å‰å¯ç”¨äº†<code>enable_vae_tiling</code>ï¼Œæ­¤æ–¹æ³•å°†å›åˆ°ä¸€æ­¥è®¡ç®—è§£ç ã€‚</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ç¦ç”¨VAEå¹³é“º</span>
pipeline.disable_vae_tiling()
</div></code></pre>
<h2 id="%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95">å·¥å…·æ–¹æ³•</h2>
<h3 id="25-progressbar-%E6%96%B9%E6%B3%95">25. <code>progress_bar</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">progress_bar</span><span class="hljs-params">(self, iterable=None, total=None)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: åˆ›å»ºè¿›åº¦æ¡ç”¨äºæ˜¾ç¤ºæ¨ç†è¿›åº¦ã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>iterable</code> (å¯é€‰): å¯è¿­ä»£å¯¹è±¡ï¼Œç”¨äºåŒ…è£…è¿›åº¦æ¡</li>
<li><code>total</code> (å¯é€‰): æ€»æ­¥æ•°ï¼Œç”¨äºåˆ›å»ºæ‰‹åŠ¨æ›´æ–°çš„è¿›åº¦æ¡</li>
</ul>
<p><strong>è¿”å›å€¼</strong>: tqdmè¿›åº¦æ¡å¯¹è±¡</p>
<p><strong>æ³¨æ„</strong>: <code>iterable</code>å’Œ<code>total</code>å¿…é¡»æä¾›å…¶ä¸­ä¸€ä¸ª</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># åŒ…è£…å¯è¿­ä»£å¯¹è±¡</span>
<span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> pipeline.progress_bar(range(<span class="hljs-number">50</span>)):
    <span class="hljs-comment"># æ‰§è¡Œæ¨ç†æ­¥éª¤</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># æ‰‹åŠ¨è¿›åº¦æ¡</span>
pbar = pipeline.progress_bar(total=<span class="hljs-number">50</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">50</span>):
    <span class="hljs-comment"># æ‰§è¡Œæ“ä½œ</span>
    pbar.update(<span class="hljs-number">1</span>)
</div></code></pre>
<hr>
<h3 id="26-setprogressbarconfig-%E6%96%B9%E6%B3%95">26. <code>set_progress_bar_config</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_progress_bar_config</span><span class="hljs-params">(self, **kwargs)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: è®¾ç½®è¿›åº¦æ¡é…ç½®å‚æ•°ã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>**kwargs</code>: tqdmè¿›åº¦æ¡çš„é…ç½®å‚æ•°</li>
</ul>
<p><strong>å¸¸ç”¨é…ç½®</strong>:</p>
<ul>
<li><code>disable</code> (<code>bool</code>): æ˜¯å¦ç¦ç”¨è¿›åº¦æ¡</li>
<li><code>desc</code> (<code>str</code>): è¿›åº¦æ¡æè¿°</li>
<li><code>leave</code> (<code>bool</code>): å®Œæˆåæ˜¯å¦ä¿ç•™è¿›åº¦æ¡</li>
<li><code>position</code> (<code>int</code>): è¿›åº¦æ¡ä½ç½®</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ç¦ç”¨è¿›åº¦æ¡</span>
pipeline.set_progress_bar_config(disable=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># è‡ªå®šä¹‰è¿›åº¦æ¡</span>
pipeline.set_progress_bar_config(
    desc=<span class="hljs-string">"ç”Ÿæˆå›¾åƒ"</span>,
    leave=<span class="hljs-literal">False</span>,
    position=<span class="hljs-number">0</span>
)
</div></code></pre>
<hr>
<h3 id="27-numpytopil-%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95">27. <code>numpy_to_pil</code> é™æ€æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-meta">@staticmethod</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">numpy_to_pil</span><span class="hljs-params">(images)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å°†NumPyå›¾åƒæˆ–å›¾åƒæ‰¹æ¬¡è½¬æ¢ä¸ºPILå›¾åƒã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>images</code>: NumPyæ•°ç»„æ ¼å¼çš„å›¾åƒ</li>
</ul>
<p><strong>è¿”å›å€¼</strong>: PILå›¾åƒåˆ—è¡¨</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># è½¬æ¢NumPyå›¾åƒä¸ºPIL</span>
numpy_images = np.random.rand(<span class="hljs-number">2</span>, <span class="hljs-number">512</span>, <span class="hljs-number">512</span>, <span class="hljs-number">3</span>)
pil_images = DiffusionPipeline.numpy_to_pil(numpy_images)
</div></code></pre>
<hr>
<h3 id="28-frompipe-%E7%B1%BB%E6%96%B9%E6%B3%95">28. <code>from_pipe</code> ç±»æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-meta">@classmethod</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">from_pipe</span><span class="hljs-params">(cls, pipeline, **kwargs)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: ä»ç»™å®šPipelineåˆ›å»ºæ–°Pipelineã€‚æ­¤æ–¹æ³•å¯¹äºä»ç°æœ‰Pipelineç»„ä»¶åˆ›å»ºæ–°Pipelineè€Œä¸é‡æ–°åˆ†é…é¢å¤–å†…å­˜å¾ˆæœ‰ç”¨ã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>pipeline</code> (<code>DiffusionPipeline</code>): æºPipeline</li>
<li><code>**kwargs</code>: è¦†ç›–ç»„ä»¶æˆ–é…ç½®çš„å‚æ•°</li>
</ul>
<p><strong>è¿”å›å€¼</strong>: å…·æœ‰ç›¸åŒæƒé‡å’Œé…ç½®çš„æ–°Pipeline</p>
<p><strong>ç‰¹ç‚¹</strong>:</p>
<ul>
<li>é‡ç”¨ç°æœ‰ç»„ä»¶ï¼ŒèŠ‚çœå†…å­˜</li>
<li>å¯ä»¥è¦†ç›–ç‰¹å®šç»„ä»¶</li>
<li>ä¿æŒåŸå§‹é…ç½®</li>
</ul>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> StableDiffusionPipeline, StableDiffusionSAGPipeline

<span class="hljs-comment"># åˆ›å»ºåŸºç¡€Pipeline</span>
base_pipe = StableDiffusionPipeline.from_pretrained(<span class="hljs-string">"stable-diffusion-v1-5/stable-diffusion-v1-5"</span>)

<span class="hljs-comment"># ä»åŸºç¡€Pipelineåˆ›å»ºSAG Pipeline</span>
sag_pipe = StableDiffusionSAGPipeline.from_pipe(base_pipe)

<span class="hljs-comment"># è¦†ç›–ç‰¹å®šç»„ä»¶</span>
new_pipe = StableDiffusionPipeline.from_pipe(
    base_pipe,
    scheduler=new_scheduler,
    torch_dtype=torch.float16
)
</div></code></pre>
<h2 id="%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD">é«˜çº§åŠŸèƒ½</h2>
<h3 id="29-enablefreeu-%E6%96%B9%E6%B3%95">29. <code>enable_freeu</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enable_freeu</span><span class="hljs-params">(self, s1: float, s2: float, b1: float, b2: float)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å¯ç”¨FreeUæœºåˆ¶ï¼Œå¦‚è®ºæ–‡https://huggingface.co/papers/2309.11497æ‰€è¿°ã€‚ç¼©æ”¾å› å­åçš„åç¼€è¡¨ç¤ºåº”ç”¨çš„é˜¶æ®µã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>s1</code> (<code>float</code>): é˜¶æ®µ1çš„ç¼©æ”¾å› å­ï¼Œç”¨äºå‡å¼±è·³è·ƒç‰¹å¾çš„è´¡çŒ®ï¼Œç¼“è§£å¢å¼ºå»å™ªè¿‡ç¨‹ä¸­çš„&quot;è¿‡åº¦å¹³æ»‘æ•ˆåº”&quot;</li>
<li><code>s2</code> (<code>float</code>): é˜¶æ®µ2çš„ç¼©æ”¾å› å­ï¼Œç”¨äºå‡å¼±è·³è·ƒç‰¹å¾çš„è´¡çŒ®</li>
<li><code>b1</code> (<code>float</code>): é˜¶æ®µ1çš„ç¼©æ”¾å› å­ï¼Œç”¨äºæ”¾å¤§éª¨å¹²ç‰¹å¾çš„è´¡çŒ®</li>
<li><code>b2</code> (<code>float</code>): é˜¶æ®µ2çš„ç¼©æ”¾å› å­ï¼Œç”¨äºæ”¾å¤§éª¨å¹²ç‰¹å¾çš„è´¡çŒ®</li>
</ul>
<p><strong>é€‚ç”¨æ¨¡å‹</strong>: éœ€è¦Pipelineå…·æœ‰<code>unet</code>ç»„ä»¶</p>
<p><strong>æ¨èå€¼</strong>: è¯·å‚è€ƒå®˜æ–¹ä»“åº“è·å–é€‚ç”¨äºä¸åŒPipelineçš„å·²çŸ¥æœ‰æ•ˆå€¼ç»„åˆ</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Stable Diffusion v1.5æ¨èå€¼</span>
pipeline.enable_freeu(s1=<span class="hljs-number">0.9</span>, s2=<span class="hljs-number">0.2</span>, b1=<span class="hljs-number">1.2</span>, b2=<span class="hljs-number">1.4</span>)

<span class="hljs-comment"># Stable Diffusion XLæ¨èå€¼</span>
pipeline.enable_freeu(s1=<span class="hljs-number">0.6</span>, s2=<span class="hljs-number">0.4</span>, b1=<span class="hljs-number">1.1</span>, b2=<span class="hljs-number">1.2</span>)
</div></code></pre>
<hr>
<h3 id="30-disablefreeu-%E6%96%B9%E6%B3%95">30. <code>disable_freeu</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">disable_freeu</span><span class="hljs-params">(self)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å¦‚æœå¯ç”¨äº†FreeUæœºåˆ¶ï¼Œåˆ™ç¦ç”¨å®ƒã€‚</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ç¦ç”¨FreeU</span>
pipeline.disable_freeu()
</div></code></pre>
<hr>
<h3 id="31-fuseqkvprojections-%E6%96%B9%E6%B3%95">31. <code>fuse_qkv_projections</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuse_qkv_projections</span><span class="hljs-params">(self, unet: bool = True, vae: bool = True)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å¯ç”¨èåˆQKVæŠ•å½±ã€‚å¯¹äºè‡ªæ³¨æ„åŠ›æ¨¡å—ï¼Œæ‰€æœ‰æŠ•å½±çŸ©é˜µï¼ˆæŸ¥è¯¢ã€é”®ã€å€¼ï¼‰éƒ½è¢«èåˆã€‚å¯¹äºäº¤å‰æ³¨æ„åŠ›æ¨¡å—ï¼Œé”®å’Œå€¼æŠ•å½±çŸ©é˜µè¢«èåˆã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>unet</code> (<code>bool</code>, é»˜è®¤ <code>True</code>): æ˜¯å¦åœ¨UNetä¸Šåº”ç”¨èåˆ</li>
<li><code>vae</code> (<code>bool</code>, é»˜è®¤ <code>True</code>): æ˜¯å¦åœ¨VAEä¸Šåº”ç”¨èåˆ</li>
</ul>
<p><strong>æ³¨æ„</strong>: ğŸ§ª è¿™æ˜¯å®éªŒæ€§API</p>
<p><strong>é™åˆ¶</strong>: VAEèåˆä»…æ”¯æŒ<code>AutoencoderKL</code>ç±»å‹</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># èåˆUNetå’ŒVAEçš„QKVæŠ•å½±</span>
pipeline.fuse_qkv_projections()

<span class="hljs-comment"># ä»…èåˆUNet</span>
pipeline.fuse_qkv_projections(unet=<span class="hljs-literal">True</span>, vae=<span class="hljs-literal">False</span>)
</div></code></pre>
<hr>
<h3 id="32-unfuseqkvprojections-%E6%96%B9%E6%B3%95">32. <code>unfuse_qkv_projections</code> æ–¹æ³•</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unfuse_qkv_projections</span><span class="hljs-params">(self, unet: bool = True, vae: bool = True)</span>
</span></div></code></pre>
<p><strong>æè¿°</strong>: å¦‚æœå¯ç”¨äº†QKVæŠ•å½±èåˆï¼Œåˆ™ç¦ç”¨å®ƒã€‚</p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>unet</code> (<code>bool</code>, é»˜è®¤ <code>True</code>): æ˜¯å¦åœ¨UNetä¸Šå–æ¶ˆèåˆ</li>
<li><code>vae</code> (<code>bool</code>, é»˜è®¤ <code>True</code>): æ˜¯å¦åœ¨VAEä¸Šå–æ¶ˆèåˆ</li>
</ul>
<p><strong>æ³¨æ„</strong>: ğŸ§ª è¿™æ˜¯å®éªŒæ€§API</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># å–æ¶ˆèåˆQKVæŠ•å½±</span>
pipeline.unfuse_qkv_projections()
</div></code></pre>
<h2 id="%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5%E5%AF%B9%E6%AF%94">å†…å­˜ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å†…å­˜èŠ‚çœ</th>
<th>æ€§èƒ½å½±å“</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>enable_model_cpu_offload()</code></td>
<td>ä¸­ç­‰</td>
<td>è½»å¾®</td>
<td>å¹³è¡¡å†…å­˜å’Œæ€§èƒ½</td>
</tr>
<tr>
<td><code>enable_sequential_cpu_offload()</code></td>
<td>é«˜</td>
<td>ä¸­ç­‰</td>
<td>å†…å­˜æåº¦å—é™</td>
</tr>
<tr>
<td><code>enable_attention_slicing()</code></td>
<td>ä¸­ç­‰</td>
<td>è½»å¾®</td>
<td>å¤§æ‰¹æ¬¡æ¨ç†</td>
</tr>
<tr>
<td><code>enable_vae_slicing()</code></td>
<td>ä½</td>
<td>å¾ˆè½»å¾®</td>
<td>VAEå†…å­˜ä¼˜åŒ–</td>
</tr>
<tr>
<td><code>enable_vae_tiling()</code></td>
<td>é«˜</td>
<td>è½»å¾®</td>
<td>è¶…é«˜åˆ†è¾¨ç‡å›¾åƒ</td>
</tr>
<tr>
<td><code>enable_xformers_memory_efficient_attention()</code></td>
<td>ä¸­ç­‰</td>
<td>è´Ÿå½±å“(åŠ é€Ÿ)</td>
<td>æœ‰xFormersç¯å¢ƒ</td>
</tr>
</tbody>
</table>
<h2 id="%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">æœ€ä½³å®è·µ</h2>
<h3 id="%E5%86%85%E5%AD%98%E5%8F%97%E9%99%90%E7%8E%AF%E5%A2%83">å†…å­˜å—é™ç¯å¢ƒ</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># æœ€å¤§å†…å­˜èŠ‚çœé…ç½®</span>
pipeline.enable_sequential_cpu_offload()
pipeline.enable_attention_slicing(<span class="hljs-string">"max"</span>)
pipeline.enable_vae_slicing()
pipeline.enable_vae_tiling()
</div></code></pre>
<h3 id="%E6%80%A7%E8%83%BD%E4%BC%98%E5%85%88%E7%8E%AF%E5%A2%83">æ€§èƒ½ä¼˜å…ˆç¯å¢ƒ</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># æ€§èƒ½ä¼˜åŒ–é…ç½®</span>
pipeline.to(<span class="hljs-string">"cuda"</span>, torch.float16)
pipeline.enable_xformers_memory_efficient_attention()
pipeline.enable_model_cpu_offload()  <span class="hljs-comment"># è½»å¾®å†…å­˜èŠ‚çœ</span>
</div></code></pre>
<h3 id="%E9%AB%98%E5%88%86%E8%BE%A8%E7%8E%87%E5%9B%BE%E5%83%8F%E7%94%9F%E6%88%90">é«˜åˆ†è¾¨ç‡å›¾åƒç”Ÿæˆ</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># é«˜åˆ†è¾¨ç‡ä¼˜åŒ–</span>
pipeline.enable_vae_tiling()
pipeline.enable_attention_slicing(<span class="hljs-string">"auto"</span>)
pipeline.enable_model_cpu_offload()
</div></code></pre>

</body>
</html>
